YUI.add("moodle-course-dragdrop",function(p,e){var o,t,g=".actions",s="activity",r="content",m="course-content",f="editing_move",i="iconsmall",n="jumpmenu",c="left",a="movedown",d="moveup",u="page-content",l="right",_="section",h="section-handle",v="summary",b="sectiondraggable";M.course=M.course||{},o=function(){o.superclass.constructor.apply(this,arguments)},p.extend(o,M.core.dragdrop,{sectionlistselector:null,initializer:function(){if(this.groups=[b],this.samenodeclass=M.course.format.get_sectionwrapperclass(),this.parentnodeclass=M.course.format.get_containerclass(),this.detectkeyboarddirection=!0,p.Node.one("."+n))return!1;if(this.sectionlistselector=M.course.format.get_section_wrapper(p),this.sectionlistselector){this.sectionlistselector="."+m+" "+this.sectionlistselector,this.setup_for_section(this.sectionlistselector);var e=new p.DD.Delegate({container:"."+m,nodes:"."+b,target:!0,handles:["."+c],dragConfig:{groups:this.groups}});e.dd.plug(p.Plugin.DDProxy,{moveOnEnd:!1}),e.dd.plug(p.Plugin.DDConstrained,{constrain:"#"+u,stickY:!0}),e.dd.plug(p.Plugin.DDWinScroll)}},setup_for_section:function(e){p.Node.all(e).each(function(e){var o,t,s,r,i,n=p.Moodle.core_course.util.section.getId(e);0<n&&(o=e.one("."+l+" a."+a),t=e.one("."+l+" a."+d),s=M.util.get_string("movesection","moodle",n),r=e.one("."+c),(o||t)&&r&&(r.setStyle("cursor","move"),r.appendChild(this.get_drag_handle(s,h,"icon",!0)),t&&(t.previous("br")?t.previous("br").remove():t.next("br")&&t.next("br").remove(),t.ancestor(".section_action_menu")&&"li"==t.ancestor().get("nodeName").toLowerCase()?t.ancestor().remove():t.remove()),o&&(o.previous("br")?o.previous("br").remove():o.next("br")&&o.next("br").remove(),i=o.ancestor().get("nodeName").toLowerCase(),o.ancestor(".section_action_menu")&&"li"==i?o.ancestor().remove():o.remove()),e.addClass(b)))},this)},drag_start:function(e){var o,t,s=e.target,r=s.get("node"),i=s.get("dragNode");r!==i&&((o=p.Node.create("<"+M.course.format.get_containernode()+"></"+M.course.format.get_containernode()+">")).addClass(M.course.format.get_containerclass()),(t=p.Node.create("<"+M.course.format.get_sectionwrappernode()+"></"+M.course.format.get_sectionwrappernode()+">")).addClass(M.course.format.get_sectionwrapperclass()),t.setStyle("margin",0),t.setContent(r.get("innerHTML")),o.appendChild(t),i.setContent(o),i.addClass(m))},drag_dropmiss:function(e){this.drop_hit(e)},get_section_index:function(e){var o="."+m+" "+M.course.format.get_section_selector(p),t=p.all(o);return t.indexOf(e)-t.indexOf(p.one("#section-0"))},drop_hit:function(n){var c,a,e,o,t,s,r=n.drag,i=r.get("node"),d=p.Moodle.core_course.util.section.getId(i),u=d,l=this.get_section_index(i),g=l;if(d!==l){for(t in g<u&&(u=l,g=d),r.get("dragNode").removeClass(m),c=p.Node.all(this.sectionlistselector),a=M.util.add_lightbox(p,i),e={},o=this.get("config").pageparams)o.hasOwnProperty(t)&&(e[t]=o[t]);e.sesskey=M.cfg.sesskey,e.courseId=this.get("courseid"),e["class"]="section",e.field="move",e.id=d,e.value=l,s=M.cfg.wwwroot+this.get("ajaxurl"),p.io(s,{method:"POST",data:e,on:{start:function(){a.show()},success:function(e,o){var t,s,r,i;try{(t=p.JSON.parse(o.responseText)).error&&new M.core.ajaxException(t),M.course.format.process_sections(p,c,t,u,g)}catch(n){}r=!1;do{for(r=!1,s=u;s<=g;s++)p.Moodle.core_course.util.section.getId(c.item(s-1))>p.Moodle.core_course.util.section.getId(c.item(s))&&(i=c.item(s-1).get("id"),c.item(s-1).set("id",c.item(s).get("id")),c.item(s).set("id",i),M.course.format.swap_sections(p,s-1,s),r=!0),c.item(s).setAttribute("data-sectionid",p.Moodle.core_course.util.section.getId(c.item(s)));--g}while(r);window.setTimeout(function(){a.hide()},250),M.course.coursebase.invoke_function("updateMovedSectionState")},failure:function(e,o){this.ajax_failure(o),a.hide()}},context:this})}}},{NAME:"course-dragdrop-section",ATTRS:{courseid:{value:null},ajaxurl:{value:0},config:{value:0}}}),M.course=M.course||{},M.course.init_section_dragdrop=function(e){new o(e)},t=function(){t.superclass.constructor.apply(this,arguments)},p.extend(t,M.core.dragdrop,{initializer:function(){var e,o,t;this.groups=["resource"],this.samenodeclass=s,this.parentnodeclass=_,this.samenodelabel={identifier:"afterresource",component:"moodle"},this.parentnodelabel={identifier:"totopofsection",component:"moodle"},(e=M.course.format.get_section_selector(p))&&(e="."+m+" "+e,this.setup_for_section(e),o=e.slice(m.length+2)+" li."+s,(t=new p.DD.Delegate({container:"."+m,nodes:o,target:!0,handles:["."+f],dragConfig:{groups:this.groups}})).dd.plug(p.Plugin.DDProxy,{moveOnEnd:!1,cloneNode:!0}),t.dd.plug(p.Plugin.DDConstrained,{constrain:"#"+u}),t.dd.plug(p.Plugin.DDWinScroll),M.course.coursebase.register_module(this),M.course.dragres=this)},setup_for_section:function(e){p.Node.all(e).each(function(e){var o=e.one("."+r+" ul."+_);o||((o=p.Node.create("<ul></ul>")).addClass(_),e.one("."+r+" div."+v).insert(o,"after")),o.setAttribute("data-draggroups",this.groups.join(" ")),new p.DD.Drop({node:o,groups:this.groups,padding:"20 0 20 0"}),this.setup_for_resource("#"+e.get("id")+" li."+s)},this)},setup_for_resource:function(e){p.Node.all(e).each(function(e){var o,t,s=e.getData("draggroups");s||(e.setAttribute("data-draggroups",this.groups.join(" ")),new p.DD.Drop({node:e,groups:this.groups,padding:"20 0 20 0"})),(o=e.one("a."+f))&&(t=o.getData("sectionreturn"),o.replace(this.get_drag_handle(M.util.get_string("movecoursemodule","moodle"),f,i,!0).setAttribute("data-sectionreturn",t)))},this)},drag_start:function(e){var o=e.target;o.get("dragNode")!==o.get("node")&&(o.get("dragNode").setContent(o.get("node").get("innerHTML")),o.get("dragNode").all("img.iconsmall").setStyle("vertical-align","baseline"))},drag_dropmiss:function(e){this.drop_hit(e)},drop_hit:function(e){var o,r,i,t,n=e.drag,c=n.get("node"),s=e.drop.get("node"),a=c.one(g),d=M.util.add_spinner(p,a),u={},l=this.get("config").pageparams;for(o in l)u[o]=l[o];r=Number(p.Moodle.core_course.util.cm.getId(c)),i=null,
u.sesskey=M.cfg.sesskey,u.courseId=this.get("courseid"),u["class"]="resource",u.field="move",u.id=r,u.sectionId=p.Moodle.core_course.util.section.getId(s.ancestor(M.course.format.get_section_wrapper(p),!0)),c.next()&&(i=Number(p.Moodle.core_course.util.cm.getId(c.next())),u.beforeId=i),t=M.cfg.wwwroot+this.get("ajaxurl"),p.io(t,{method:"POST",data:u,on:{start:function(){this.lock_drag_handle(n,f),d.show()},success:function(e,o){var t,s=p.JSON.parse(o.responseText);M.course.coursebase.invoke_function("updateMovedCmState",{cmid:r,beforeid:i,visible:s.visible}),t={element:c,visible:s.visible},M.course.coursebase.invoke_function("set_visibility_resource_ui",t),this.unlock_drag_handle(n,f),window.setTimeout(function(){d.hide()},250)},failure:function(e,o){this.ajax_failure(o),this.unlock_drag_handle(n,h),d.hide()}},context:this})}},{NAME:"course-dragdrop-resource",ATTRS:{courseid:{value:null},ajaxurl:{value:0},config:{value:0}}}),M.course=M.course||{},M.course.init_resource_dragdrop=function(e){new t(e)}},"@VERSION@",{requires:["base","node","io","dom","dd","dd-scroll","moodle-core-dragdrop","moodle-core-notification","moodle-course-coursebase","moodle-course-util"]});