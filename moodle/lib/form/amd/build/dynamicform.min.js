function _typeof(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(a){return typeof a}}else{_typeof=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return _typeof(a)}define ("core_form/dynamicform",["exports","core_form/changechecker","core_form/events","core/ajax","core/fragment","core/notification","core/pending","core/templates","core/str"],function(a,b,c,d,e,f,g,h,i){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.default=void 0;b=l(b);c=l(c);d=j(d);e=j(e);f=j(f);g=j(g);h=j(h);function j(a){return a&&a.__esModule?a:{default:a}}function k(){if("function"!=typeof WeakMap)return null;var a=new WeakMap;k=function(){return a};return a}function l(a){if(a&&a.__esModule){return a}if(null===a||"object"!==_typeof(a)&&"function"!=typeof a){return{default:a}}var b=k();if(b&&b.has(a)){return b.get(a)}var c={},d=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e in a){if(Object.prototype.hasOwnProperty.call(a,e)){var f=d?Object.getOwnPropertyDescriptor(a,e):null;if(f&&(f.get||f.set)){Object.defineProperty(c,e,f)}else{c[e]=a[e]}}}c.default=a;if(b){b.set(a,c)}return c}function m(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function n(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var h=a.apply(b,c);function f(a){m(h,d,e,f,g,"next",a)}function g(a){m(h,d,e,f,g,"throw",a)}f(void 0)})}}function o(a){return s(a)||r(a)||q(a)||p()}function p(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function q(a,b){if(!a)return;if("string"==typeof a)return t(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return t(a,b)}function r(a){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(a))return Array.from(a)}function s(a){if(Array.isArray(a))return t(a)}function t(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}function u(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}function v(a,b){for(var c=0,d;c<b.length;c++){d=b[c];d.enumerable=d.enumerable||!1;d.configurable=!0;if("value"in d)d.writable=!0;Object.defineProperty(a,d.key,d)}}function w(a,b,c){if(b)v(a.prototype,b);if(c)v(a,c);return a}function x(a,b,c){if(b in a){Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0})}else{a[b]=c}return a}var y=function(){function a(b,c){var d=this;u(this,a);x(this,"events",{FORM_SUBMITTED:"core_form_dynamicform_formsubmitted",FORM_CANCELLED:"core_form_dynamicform_formcancelled",CLIENT_VALIDATION_ERROR:"core_form_dynamicform_clientvalidationerror",SERVER_VALIDATION_ERROR:"core_form_dynamicform_validationerror",ERROR:"core_form_dynamicform_error",NOSUBMIT_BUTTON_PRESSED:"core_form_dynamicform_nosubmitbutton",SUBMIT_BUTTON_PRESSED:"core_form_dynamicform_submitbutton",CANCEL_BUTTON_PRESSED:"core_form_dynamicform_cancelbutton"});this.formClass=c;this.container=b;(0,i.get_strings)([{key:"collapseall",component:"moodle"},{key:"expandall",component:"moodle"}]).catch(f.default.exception);this.container.addEventListener("click",function(a){if(a.target.matches("form input[type=submit][data-cancel]")){a.preventDefault();var b=d.trigger(d.events.CANCEL_BUTTON_PRESSED,a.target);if(!b.defaultPrevented){d.processCancelButton()}}else if(a.target.matches("form input[type=submit][data-no-submit=\"1\"]")){a.preventDefault();var c=d.trigger(d.events.NOSUBMIT_BUTTON_PRESSED,a.target);if(!c.defaultPrevented){d.processNoSubmitButton(a.target)}}});this.container.addEventListener("submit",function(a){if(a.target.matches("form")){a.preventDefault();var b=d.trigger(d.events.SUBMIT_BUTTON_PRESSED);if(!b.defaultPrevented){d.submitFormAjax()}}})}w(a,[{key:"load",value:function load(){var a=this,b=0<arguments.length&&arguments[0]!==void 0?arguments[0]:null,c=new URLSearchParams(Object.entries(b||{})),d=new g.default("core_form/dynamicform:load");return this.getBody(c.toString()).then(function(b){return a.updateForm(b)}).then(d.resolve)}},{key:"trigger",value:function trigger(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:null,c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:!0,d=new CustomEvent(a,{detail:b,cancelable:c});this.container.dispatchEvent(d);return d}},{key:"addEventListener",value:function addEventListener(){var a;(a=this.container).addEventListener.apply(a,arguments)}},{key:"getBody",value:function getBody(a){return d.default.call([{methodname:"core_form_dynamic_form",args:{formdata:a,form:this.formClass}}])[0].then(function(a){return{html:a.html,js:e.default.processCollectedJavascript(a.javascript)}})}},{key:"onSubmitSuccess",value:function onSubmitSuccess(a){var b=this.trigger(this.events.FORM_SUBMITTED,a);if(b.defaultPrevented){return}this.container.innerHTML=""}},{key:"onSubmitError",value:function onSubmitError(a){var b=this.trigger(this.events.ERROR,a);if(b.defaultPrevented){return}f.default.exception(a)}},{key:"processNoSubmitButton",value:function processNoSubmitButton(a){var b=this,d=new g.default("core_form/dynamicform:nosubmit"),e=this.getFormNode(),f=new URLSearchParams(o(new FormData(e).entries()));f.append(a.getAttribute("name"),a.getAttribute("value"));c.notifyFormSubmittedByJavascript(e,!0);this.disableButtons();this.getBody(f.toString()).then(this.updateForm).then(d.resolve).catch(function(a){return b.onSubmitError(a)})}},{key:"getFormNode",value:function getFormNode(){return this.container.querySelector("form")}},{key:"notifyResetFormChanges",value:function notifyResetFormChanges(){c.notifyFormSubmittedByJavascript(this.getFormNode(),!0);b.resetFormDirtyState(this.getFormNode())}},{key:"processCancelButton",value:function processCancelButton(){this.notifyResetFormChanges();var a=this.trigger(this.events.FORM_CANCELLED);if(!a.defaultPrevented){this.container.innerHTML=""}}},{key:"updateForm",value:function updateForm(a){var b=a.html,c=a.js;return h.default.replaceNodeContents(this.container,b,c)}},{key:"validateElements",value:function validateElements(){c.notifyFormSubmittedByJavascript(this.getFormNode());var a=o(this.container.querySelectorAll("[aria-invalid=\"true\"], .error"));if(a.length){a[0].focus();return!1}return!0}},{key:"disableButtons",value:function disableButtons(){this.container.querySelectorAll("form input[type=\"submit\"]").forEach(function(a){return a.setAttribute("disabled",!0)})}},{key:"enableButtons",value:function enableButtons(){this.container.querySelectorAll("form input[type=\"submit\"]").forEach(function(a){return a.removeAttribute("disabled")})}},{key:"submitFormAjax",value:function(){var a=n(regeneratorRuntime.mark(function a(){var b=this,c,f;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.next=2;return this.validateElements();case 2:if(a.sent){a.next=5;break}this.trigger(this.events.CLIENT_VALIDATION_ERROR,null,!1);return a.abrupt("return");case 5:this.disableButtons();c=this.container.querySelector("form");f=new URLSearchParams(o(new FormData(c).entries()));d.default.call([{methodname:"core_form_dynamic_form",args:{formdata:f.toString(),form:this.formClass}}])[0].then(function(a){if(!a.submitted){b.updateForm({html:a.html,js:e.default.processCollectedJavascript(a.javascript)});b.enableButtons();b.trigger(b.events.SERVER_VALIDATION_ERROR,null,!1)}else{var c=JSON.parse(a.data);b.enableButtons();b.notifyResetFormChanges();b.onSubmitSuccess(c)}return null}).catch(function(a){return b.onSubmitError(a)});case 9:case"end":return a.stop();}}},a,this)}));return function submitFormAjax(){return a.apply(this,arguments)}}()}]);return a}();a.default=y;return a.default});
//# sourceMappingURL=dynamicform.min.js.map
