function _typeof(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(a){return typeof a}}else{_typeof=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return _typeof(a)}define ("core_form/modalform",["exports","core/ajax","core_form/changechecker","core_form/events","core/fragment","core/modal_events","core/modal_factory","core/notification","core/pending"],function(a,b,c,d,e,f,g,h,i){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.default=void 0;b=l(b);c=k(c);d=k(d);e=l(e);f=l(f);g=l(g);h=l(h);i=l(i);function j(){if("function"!=typeof WeakMap)return null;var a=new WeakMap;j=function(){return a};return a}function k(a){if(a&&a.__esModule){return a}if(null===a||"object"!==_typeof(a)&&"function"!=typeof a){return{default:a}}var b=j();if(b&&b.has(a)){return b.get(a)}var c={},d=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e in a){if(Object.prototype.hasOwnProperty.call(a,e)){var f=d?Object.getOwnPropertyDescriptor(a,e):null;if(f&&(f.get||f.set)){Object.defineProperty(c,e,f)}else{c[e]=a[e]}}}c.default=a;if(b){b.set(a,c)}return c}function l(a){return a&&a.__esModule?a:{default:a}}function m(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function n(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var h=a.apply(b,c);function f(a){m(h,d,e,f,g,"next",a)}function g(a){m(h,d,e,f,g,"throw",a)}f(void 0)})}}function o(a){return s(a)||r(a)||q(a)||p()}function p(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function q(a,b){if(!a)return;if("string"==typeof a)return t(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return t(a,b)}function r(a){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(a))return Array.from(a)}function s(a){if(Array.isArray(a))return t(a)}function t(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}function u(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);if(b)d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable});c.push.apply(c,d)}return c}function v(a){for(var b=1,c;b<arguments.length;b++){c=null!=arguments[b]?arguments[b]:{};if(b%2){u(Object(c),!0).forEach(function(b){z(a,b,c[b])})}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(a,Object.getOwnPropertyDescriptors(c))}else{u(Object(c)).forEach(function(b){Object.defineProperty(a,b,Object.getOwnPropertyDescriptor(c,b))})}}return a}function w(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}function x(a,b){for(var c=0,d;c<b.length;c++){d=b[c];d.enumerable=d.enumerable||!1;d.configurable=!0;if("value"in d)d.writable=!0;Object.defineProperty(a,d.key,d)}}function y(a,b,c){if(b)x(a.prototype,b);if(c)x(a,c);return a}function z(a,b,c){if(b in a){Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0})}else{a[b]=c}return a}var A=function(){function a(b){w(this,a);z(this,"events",{FORM_SUBMITTED:"core_form_modalform_formsubmitted",FORM_CANCELLED:"core_form_modalform_formcancelled",CLIENT_VALIDATION_ERROR:"core_form_modalform_clientvalidationerror",SERVER_VALIDATION_ERROR:"core_form_modalform_validationerror",ERROR:"core_form_modalform_error",NOSUBMIT_BUTTON_PRESSED:"core_form_modalform_nosubmitbutton",SUBMIT_BUTTON_PRESSED:"core_form_modalform_submitbutton",CANCEL_BUTTON_PRESSED:"core_form_modalform_cancelbutton",LOADED:"core_form_modalform_loaded"});this.modal=null;this.config=b;this.config.modalConfig=v({removeOnClose:!0,type:g.default.types.SAVE_CANCEL,large:!0},this.config.modalConfig||{});this.config.args=this.config.args||{};this.futureListeners=[]}y(a,[{key:"show",value:function show(){var a=this,b=new i.default("core_form/modalform:init");return g.default.create(this.config.modalConfig).then(function(b){a.modal=b;var c=new URLSearchParams(Object.entries(a.config.args||{})),d=a.getBody(c.toString());a.modal.setBodyContent(d);d.catch(h.default.exception);a.modal.getRoot().on(f.default.hidden,function(){a.notifyResetFormChanges();a.modal.destroy();if(a.config.returnFocus){a.config.returnFocus.focus()}});a.modal.getModal().addClass("modal-form-dialogue");a.modal.getRoot().on("click","form input[type=submit][data-no-submit]",function(b){b.preventDefault();var c=a.trigger(a.events.NOSUBMIT_BUTTON_PRESSED,b.target);if(!c.defaultPrevented){a.processNoSubmitButton(b.target)}});a.modal.getRoot().on("submit","form",function(b){b.preventDefault();var c=a.trigger(a.events.SUBMIT_BUTTON_PRESSED);if(!c.defaultPrevented){a.submitFormAjax()}});if("undefined"!=typeof a.config.saveButtonText&&"undefined"!=typeof a.modal.setSaveButtonText){a.modal.setSaveButtonText(a.config.saveButtonText)}if("undefined"!=typeof a.config.saveButtonClasses){a.setSaveButtonClasses(a.config.saveButtonClasses)}a.modal.getRoot().on(f.default.save,function(b){b.preventDefault();a.modal.getRoot().find("form").submit()});a.modal.getRoot().on(f.default.cancel,function(b){var c=a.trigger(a.events.CANCEL_BUTTON_PRESSED);if(c.defaultPrevented){b.preventDefault()}});a.futureListeners.forEach(function(b){var c;return(c=a.modal.getRoot()[0]).addEventListener.apply(c,o(b))});a.futureListeners=[];a.trigger(a.events.LOADED,null,!1);return a.modal.show()}).then(b.resolve)}},{key:"trigger",value:function trigger(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:null,c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:!0,d=new CustomEvent(a,{detail:b,cancelable:c});this.modal.getRoot()[0].dispatchEvent(d);return d}},{key:"addEventListener",value:function addEventListener(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++){b[c]=arguments[c]}if(!this.modal){this.futureListeners.push(b)}else{var d;(d=this.modal.getRoot()[0]).addEventListener.apply(d,b)}}},{key:"getBody",value:function getBody(a){var c={formdata:a,form:this.config.formClass},d=new i.default("core_form/modalform:form_body");return b.default.call([{methodname:"core_form_dynamic_form",args:c}])[0].then(function(a){d.resolve();return{html:a.html,js:e.default.processCollectedJavascript(a.javascript)}})}},{key:"onSubmitError",value:function onSubmitError(a){var b=this.trigger(this.events.ERROR,a);if(b.defaultPrevented){return}h.default.exception(a)}},{key:"notifyResetFormChanges",value:function notifyResetFormChanges(){var a=this.getFormNode();d.notifyFormSubmittedByJavascript(this.getFormNode(),!0);if(!a){return}c.resetFormDirtyState(this.getFormNode())}},{key:"getFormNode",value:function getFormNode(){return this.modal.getRoot().find("form")[0]}},{key:"processNoSubmitButton",value:function processNoSubmitButton(a){var b=this.getFormNode();if(!b){return}d.notifyFormSubmittedByJavascript(b,!0);var c=this.modal.getRoot().find("form").serialize();c=c+"&"+encodeURIComponent(a.getAttribute("name"))+"="+encodeURIComponent(a.getAttribute("value"));var e=this.getBody(c);this.modal.setBodyContent(e);e.catch(h.default.exception)}},{key:"validateElements",value:function validateElements(){d.notifyFormSubmittedByJavascript(this.getFormNode());var a=this.modal.getRoot().find("[aria-invalid=\"true\"], .error");if(a.length){a.first().focus();return!1}return!0}},{key:"disableButtons",value:function disableButtons(){this.modal.getFooter().find("[data-action]").attr("disabled",!0)}},{key:"enableButtons",value:function enableButtons(){this.modal.getFooter().find("[data-action]").removeAttr("disabled")}},{key:"submitFormAjax",value:function(){var a=n(regeneratorRuntime.mark(function a(){var c=this,d;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:if(this.validateElements()){a.next=3;break}this.trigger(this.events.CLIENT_VALIDATION_ERROR,null,!1);return a.abrupt("return");case 3:this.disableButtons();d=this.modal.getRoot().find("form").serialize();b.default.call([{methodname:"core_form_dynamic_form",args:{formdata:d,form:this.config.formClass}}])[0].then(function(a){if(!a.submitted){var b=new Promise(function(b){return b({html:a.html,js:e.default.processCollectedJavascript(a.javascript)})});c.modal.setBodyContent(b);c.enableButtons();c.trigger(c.events.SERVER_VALIDATION_ERROR)}else{var d=JSON.parse(a.data);c.notifyResetFormChanges();var f=c.trigger(c.events.FORM_SUBMITTED,d);if(!f.defaultPrevented){c.modal.hide()}}return null}).catch(function(a){return c.onSubmitError(a)});case 6:case"end":return a.stop();}}},a,this)}));return function submitFormAjax(){return a.apply(this,arguments)}}()},{key:"setSaveButtonClasses",value:function setSaveButtonClasses(a){var b=this.modal.getFooter().find("[data-action='save']");if(!b){throw new Error("Unable to find the 'save' button")}b.removeClass().addClass(a)}}]);return a}();a.default=A;return a.default});
//# sourceMappingURL=modalform.min.js.map
