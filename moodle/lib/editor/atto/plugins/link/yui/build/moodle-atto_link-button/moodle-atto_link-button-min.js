YUI.add("moodle-atto_link-button",function(r,t){var n="atto_link",i={NEWWINDOW:"atto_link_openinnewwindow",URLINPUT:"atto_link_urlentry",URLTEXT:"atto_link_urltext"},c=".atto_link_openinnewwindow",s=".atto_link_urlentry",u=".atto_link_urltext",o=".submit",l=".openlinkbrowser";r.namespace("M.atto_link").Button=r.Base.create("button",r.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_content:null,_hasTextToDisplay:!1,initializer:function(){this.addButton({icon:"e/insert_edit_link",keys:"75",callback:this._displayDialogue,tags:"a",tagMatchRequiresAll:!1}),this.addButton({buttonName:"unlink",callback:this._unlink,icon:"e/remove_link",title:"unlink",tags:"a",tagMatchRequiresAll:!1})},_displayDialogue:function(){if(this._currentSelection=this.get("host").getSelection(),!1!==this._currentSelection){var t=this.getDialogue({headerContent:M.util.get_string("createlink",n),width:"auto",focusAfterHide:!0,focusOnShowSelector:s});t.set("bodyContent",this._getDialogueContent()),this._resolveAnchors(),t.show()}},_resolveAnchors:function(){var t,e,n,i,o,l=this.get("host").getSelectionParentNode();l&&(0<(t=this._findSelectedAnchors(r.one(l))).length?(e=t[0],this._currentSelection=this.get("host").getSelectionFromNode(e),n=e.getAttribute("href"),i=e.getAttribute("target"),o=e.get("innerText"),""!==n&&this._content.one(s).setAttribute("value",n),""!==o&&this._content.one(u).set("value",o),"_blank"===i?this._content.one(c).setAttribute("checked","checked"):this._content.one(c).removeAttribute("checked")):""!==(o=window.getSelection().toString())&&(this._hasTextToDisplay=!0,this._content.one(u).set("value",o)))},_filepickerCallback:function(t){this.getDialogue().set("focusAfterHide",null).hide(),""!==t.url&&(this._setLinkOnSelection(t.url),this.markUpdated())},_setLink:function(t){var e;t.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),""!==(e=this._content.one(s).get("value"))&&(e=e.trim(),new RegExp(/^[a-zA-Z]*\.*\/|^#|^[a-zA-Z]*:/).test(e)||(e="http://"+e),this._setLinkOnSelection(e),this.markUpdated())},_setLinkOnSelection:function(t){var e,n,i,o,l,s,a=this.get("host");if(this.editor.focus(),a.setSelection(this._currentSelection),o=!this._currentSelection[0].collapsed,l=this._content.one(u),""===(s=l.get("value").replace(/(<([^>]+)>)/gi,"").trim())&&(s=t),o?(document.execCommand("unlink",!1,null),document.execCommand("createLink",!1,t),n=a.getSelectionParentNode()):((e=r.Node.create("<a>"+s+"</a>")).setAttribute("href",t),n=a.insertContentAtFocusPoint(e.get("outerHTML")),a.setSelection(a.getSelectionFromNode(n))),n)return i=this._findSelectedAnchors(r.one(n)),r.Array.each(i,function(t){this._content.one(c).get("checked")?t.setAttribute("target","_blank"):t.removeAttribute("target"),o&&t.set("innerText",s)},this),n},_findSelectedAnchors:function(t){var e,n,i=t.get("tagName");return i&&"a"===i.toLowerCase()?[t]:(n=[],t.all("a").each(function(t){!e&&this.get("host").selectionContainsNode(t)&&n.push(t)},this),0<n.length?n:(e=t.ancestor("a"))?[e]:[])},_getDialogueContent:function(){var t=this.get("host").canShowFilepicker("link"),e=r.Handlebars.compile('<form class="atto_form"><div class="mb-1"><label for="{{elementid}}_atto_link_urltext">{{get_string "texttodisplay" component}}</label><input class="form-control fullwidth {{CSS.URLTEXT}}" type="text" id="{{elementid}}_atto_link_urltext" size="32"/></div>{{#if showFilepicker}}<label for="{{elementid}}_atto_link_urlentry">{{get_string "enterurl" component}}</label><div class="input-group input-append w-100 mb-1"><input class="form-control url {{CSS.URLINPUT}}" type="url" id="{{elementid}}_atto_link_urlentry"/><span class="input-group-append"><button class="btn btn-secondary openlinkbrowser" type="button">{{get_string "browserepositories" component}}</button></span></div>{{else}}<div class="mb-1"><label for="{{elementid}}_atto_link_urlentry">{{get_string "enterurl" component}}</label><input class="form-control fullwidth url {{CSS.URLINPUT}}" type="url" id="{{elementid}}_atto_link_urlentry" size="32"/></div>{{/if}}<div class="form-check"><input type="checkbox" class="form-check-input newwindow {{CSS.NEWWINDOW}}" id="{{elementid}}_{{CSS.NEWWINDOW}}"/><label class="form-check-label" for="{{elementid}}_{{CSS.NEWWINDOW}}">{{get_string "openinnewwindow" component}}</label></div><div class="mdl-align"><br/><button type="submit" class="btn btn-secondary submit">{{get_string "createlink" component}}</button></div></form>');return this._content=r.Node.create(e({showFilepicker:t,component:n,CSS:i})),this._content.one(s).on("keyup",this._updateTextToDisplay,this),this._content.one(u).on("keyup",this._setTextToDisplayState,this),this._content.one(o).on("click",this._setLink,this),t&&this._content.one(l).on("click",function(t){t.preventDefault(),this.get("host").showFilepicker("link",this._filepickerCallback,this)},this),this._content},_unlink:function(){var t,n=this.get("host"),e=n.getSelection();e&&e.length&&(e[0].startOffset===e[0].endOffset?(t=n.getSelectedNodes())&&(t.each(function(t){var e=t.ancestor("a",!0);e&&(n.setSelection(n.getSelectionFromNode(e)),document.execCommand("unlink",!1,null))},this),this.markUpdated()):(document.execCommand("unlink",!1,null),this.markUpdated()))},_setTextToDisplayState:function(){var t;t=this._content.one(u).get("value"),this._hasTextToDisplay=""!==t},_updateTextToDisplay:function(){var t,e,n;t=this._content.one(s),e=this._content.one(u),n=t.get("value"),this._hasTextToDisplay||e.set("value",n)}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});