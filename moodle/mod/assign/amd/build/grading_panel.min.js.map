{"version":3,"sources":["../src/grading_panel.js"],"names":["define","$","Y","notification","templates","fragment","ajax","str","checker","GradingEvents","FormEvents","Toast","FormChangeChecker","GradingPanel","selector","_regionSelector","_region","_userCache","registerEventListeners","prototype","_lastUserId","_lastAttemptNumber","nextUserId","nextUser","_niceReplaceNodeContents","node","html","js","promise","Deferred","fadeOut","replaceNodeContents","fadeIn","resolve","_saveFormState","checked","prop","val","_submitForm","event","commentAreaElement","document","querySelector","commentTextAreaElement","value","commentActionPostElement","click","form","find","show","markFormSubmitted","trigger","notifyFormSubmittedByJavascript","data","serialize","assignmentid","attr","call","methodname","args","userid","jsonformdata","JSON","stringify","done","_handleFormSubmissionResponse","bind","fail","exception","formdata","response","length","get_string","then","add","catch","resetFormDirtyState","hide","_resetForm","e","Event","_refreshGradingPanel","_chooseAttempt","link","target","submissionsId","submissionsform","getElementById","formcopy","clone","formhtml","wrap","get_strings","key","component","strs","confirm","attemptnumber","_addPopoutButtons","region","render","parents","closest","addClass","parent","append","on","_togglePopout","preventDefault","container","hasClass","removeClass","submissiondata","contextid","window","M","util","js_pending","params","loadFragment","saveFormState","js_complete","_getNextUser","_handleSaveAndShowNext","getPanelElement","collapsePanel","expandPanel","docElement","COLLAPSE_GRADE_PANEL","COLLAPSE_REVIEW_PANEL","EXPAND_GRADE_PANEL"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript controller for the \"Grading\" panel at the right of the page.\n *\n * @module     mod_assign/grading_panel\n * @copyright  2016 Damyon Wiese <damyon@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.1\n */\ndefine([\n    'jquery',\n    'core/yui',\n    'core/notification',\n    'core/templates',\n    'core/fragment',\n    'core/ajax',\n    'core/str',\n    'mod_assign/grading_form_change_checker',\n    'mod_assign/grading_events',\n    'core_form/events',\n    'core/toast',\n    'core_form/changechecker',\n], function(\n    $,\n    Y,\n    notification,\n    templates,\n    fragment,\n    ajax,\n    str,\n    checker,\n    GradingEvents,\n    FormEvents,\n    Toast,\n    FormChangeChecker\n) {\n\n    /**\n     * GradingPanel class.\n     *\n     * @class mod_assign/grading_panel\n     * @param {String} selector The selector for the page region containing the user navigation.\n     */\n    var GradingPanel = function(selector) {\n        this._regionSelector = selector;\n        this._region = $(selector);\n        this._userCache = [];\n\n        this.registerEventListeners();\n    };\n\n    /** @property {String} Selector for the page region containing the user navigation. */\n    GradingPanel.prototype._regionSelector = null;\n\n    /** @property {Integer} Remember the last user id to prevent unnessecary reloads. */\n    GradingPanel.prototype._lastUserId = 0;\n\n    /** @property {Integer} Remember the last attempt number to prevent unnessecary reloads. */\n    GradingPanel.prototype._lastAttemptNumber = -1;\n\n    /** @property {JQuery} JQuery node for the page region containing the user navigation. */\n    GradingPanel.prototype._region = null;\n\n     /** @property {Integer} The id of the next user in the grading list */\n    GradingPanel.prototype.nextUserId = null;\n\n     /** @property {Boolean} Next user exists in the grading list */\n    GradingPanel.prototype.nextUser = false;\n\n    /**\n     * Fade the dom node out, update it, and fade it back.\n     *\n     * @private\n     * @method _niceReplaceNodeContents\n     * @param {JQuery} node\n     * @param {String} html\n     * @param {String} js\n     * @return {Deferred} promise resolved when the animations are complete.\n     */\n    GradingPanel.prototype._niceReplaceNodeContents = function(node, html, js) {\n        var promise = $.Deferred();\n\n        node.fadeOut(\"fast\", function() {\n            templates.replaceNodeContents(node, html, js);\n            node.fadeIn(\"fast\", function() {\n                promise.resolve();\n            });\n        });\n\n        return promise.promise();\n    };\n\n    /**\n     * Make sure all form fields have the latest saved state.\n     * @private\n     * @method _saveFormState\n     */\n    GradingPanel.prototype._saveFormState = function() {\n        // Copy data from notify students checkbox which was moved out of the form.\n        var checked = $('[data-region=\"grading-actions-form\"] [name=\"sendstudentnotifications\"]').prop(\"checked\");\n        $('.gradeform [name=\"sendstudentnotifications\"]').val(checked);\n    };\n\n    /**\n     * Make form submit via ajax.\n     *\n     * @private\n     * @param {Object} event\n     * @param {Integer} nextUserId\n     * @param {Boolean} nextUser optional. Load next user in the grading list.\n     * @method _submitForm\n     * @fires event:formSubmittedByJavascript\n     */\n    GradingPanel.prototype._submitForm = function(event, nextUserId, nextUser) {\n        // If the form has data in comment-area, then we need to save that comment\n        var commentAreaElement = document.querySelector('.comment-area');\n        if (commentAreaElement) {\n            var commentTextAreaElement = commentAreaElement.querySelector('.db > textarea');\n            if (commentTextAreaElement.value !== '') {\n                var commentActionPostElement = commentAreaElement.querySelector('.fd a[id^=\"comment-action-post-\"]');\n                commentActionPostElement.click();\n            }\n        }\n\n        // The form was submitted - send it via ajax instead.\n        var form = $(this._region.find('form.gradeform'));\n\n        $('[data-region=\"overlay\"]').show();\n\n        // Mark the form as submitted in the change checker.\n        FormChangeChecker.markFormSubmitted(form[0]);\n\n        // We call this, so other modules can update the form with the latest state.\n        form.trigger('save-form-state');\n\n        // Tell all form fields we are about to submit the form.\n        FormEvents.notifyFormSubmittedByJavascript(form[0]);\n\n        // Now we get all the current values from the form.\n        var data = form.serialize();\n        var assignmentid = this._region.attr('data-assignmentid');\n\n        // Now we can continue...\n        ajax.call([{\n            methodname: 'mod_assign_submit_grading_form',\n            args: {assignmentid: assignmentid, userid: this._lastUserId, jsonformdata: JSON.stringify(data)},\n            done: this._handleFormSubmissionResponse.bind(this, data, nextUserId, nextUser),\n            fail: notification.exception\n        }]);\n    };\n\n    /**\n     * Handle form submission response.\n     *\n     * @private\n     * @method _handleFormSubmissionResponse\n     * @param {Array} formdata - submitted values\n     * @param {Number} [nextUserId] The id of the user to load after the form is saved\n     * @param {Boolean} [nextUser] - Whether to switch to next user in the grading list.\n     * @param {Array} response List of errors.\n     */\n    GradingPanel.prototype._handleFormSubmissionResponse = function(formdata, nextUserId, nextUser, response) {\n        if (typeof nextUserId === \"undefined\") {\n            nextUserId = this._lastUserId;\n        }\n        if (response.length) {\n            // There was an error saving the grade. Re-render the form using the submitted data so we can show\n            // validation errors.\n            $(document).trigger('reset', [this._lastUserId, formdata]);\n        } else {\n            str.get_string('gradechangessaveddetail', 'mod_assign')\n            .then(function(str) {\n                Toast.add(str);\n                return str;\n            })\n            .catch(notification.exception);\n\n            // Reset the form state.\n            var form = $(this._region.find('form.gradeform'));\n            FormChangeChecker.resetFormDirtyState(form[0]);\n\n            if (nextUserId == this._lastUserId) {\n                $(document).trigger('reset', nextUserId);\n            } else if (nextUser) {\n                $(document).trigger('done-saving-show-next', true);\n            } else {\n                $(document).trigger('user-changed', nextUserId);\n            }\n        }\n        $('[data-region=\"overlay\"]').hide();\n    };\n\n    /**\n     * Refresh form with default values.\n     *\n     * @private\n     * @method _resetForm\n     * @param {Event} e\n     * @param {Integer} userid\n     * @param {Array} formdata\n     */\n    GradingPanel.prototype._resetForm = function(e, userid, formdata) {\n        // The form was cancelled - refresh with default values.\n        var event = $.Event(\"custom\");\n        if (typeof userid == \"undefined\") {\n            userid = this._lastUserId;\n        }\n        this._lastUserId = 0;\n        this._refreshGradingPanel(event, userid, formdata);\n    };\n\n    /**\n     * Open a picker to choose an older attempt.\n     *\n     * @private\n     * @param {Object} e\n     * @method _chooseAttempt\n     */\n    GradingPanel.prototype._chooseAttempt = function(e) {\n        // Show a dialog.\n\n        // The form is in the element pointed to by data-submissions.\n        var link = $(e.target);\n        var submissionsId = link.data('submissions');\n        var submissionsform = $(document.getElementById(submissionsId));\n        var formcopy = submissionsform.clone();\n        var formhtml = formcopy.wrap($('<form/>')).html();\n\n        str.get_strings([\n            {key: 'viewadifferentattempt', component: 'mod_assign'},\n            {key: 'view', component: 'core'},\n            {key: 'cancel', component: 'core'},\n        ]).done(function(strs) {\n            notification.confirm(strs[0], formhtml, strs[1], strs[2], function() {\n                var attemptnumber = $(\"input:radio[name='select-attemptnumber']:checked\").val();\n\n                this._refreshGradingPanel(null, this._lastUserId, '', attemptnumber);\n            }.bind(this));\n        }.bind(this)).fail(notification.exception);\n    };\n\n    /**\n     * Add popout buttons\n     *\n     * @private\n     * @method _addPopoutButtons\n     * @param {JQuery} selector The region selector to add popout buttons to.\n     */\n    GradingPanel.prototype._addPopoutButtons = function(selector) {\n        var region = $(selector);\n\n        templates.render('mod_assign/popout_button', {}).done(function(html) {\n            var parents = region.find('[data-fieldtype=\"filemanager\"],[data-fieldtype=\"editor\"],[data-fieldtype=\"grading\"]')\n                    .closest('.fitem');\n            parents.addClass('has-popout').find('label').parent().append(html);\n\n            region.on('click', '[data-region=\"popout-button\"]', this._togglePopout.bind(this));\n        }.bind(this)).fail(notification.exception);\n    };\n\n    /**\n     * Make a div \"popout\" or \"popback\".\n     *\n     * @private\n     * @method _togglePopout\n     * @param {Event} event\n     */\n    GradingPanel.prototype._togglePopout = function(event) {\n        event.preventDefault();\n        var container = $(event.target).closest('.fitem');\n        if (container.hasClass('popout')) {\n            $('.popout').removeClass('popout');\n        } else {\n            $('.popout').removeClass('popout');\n            container.addClass('popout');\n            container.addClass('moodle-has-zindex');\n        }\n    };\n\n    /**\n     * Get the user context - re-render the template in the page.\n     *\n     * @private\n     * @method _refreshGradingPanel\n     * @param {Event} event\n     * @param {Number} userid\n     * @param {String} submissiondata serialised submission data.\n     * @param {Integer} attemptnumber\n     */\n    GradingPanel.prototype._refreshGradingPanel = function(event, userid, submissiondata, attemptnumber) {\n        var contextid = this._region.attr('data-contextid');\n        if (typeof submissiondata === 'undefined') {\n            submissiondata = '';\n        }\n        if (typeof attemptnumber === 'undefined') {\n            attemptnumber = -1;\n        }\n        // Skip reloading if it is the same user.\n        if (this._lastUserId == userid && this._lastAttemptNumber == attemptnumber && submissiondata === '') {\n            return;\n        }\n        this._lastUserId = userid;\n        this._lastAttemptNumber = attemptnumber;\n        $(document).trigger('start-loading-user');\n        // Tell behat to back off too.\n        window.M.util.js_pending('mod-assign-loading-user');\n        // First insert the loading template.\n        templates.render('mod_assign/loading', {}).done(function(html, js) {\n            // Update the page.\n            this._niceReplaceNodeContents(this._region, html, js).done(function() {\n                if (userid > 0) {\n                    this._region.show();\n                    // Reload the grading form \"fragment\" for this user.\n                    var params = {userid: userid, attemptnumber: attemptnumber, jsonformdata: JSON.stringify(submissiondata)};\n                    fragment.loadFragment('mod_assign', 'gradingpanel', contextid, params).done(function(html, js) {\n                        this._niceReplaceNodeContents(this._region, html, js)\n                        .done(function() {\n                            checker.saveFormState('[data-region=\"grade-panel\"] .gradeform');\n                            $(document).on('editor-content-restored', function() {\n                                // If the editor has some content that has been restored\n                                // then save the form state again for comparison.\n                                checker.saveFormState('[data-region=\"grade-panel\"] .gradeform');\n                            });\n                            $('[data-region=\"attempt-chooser\"]').on('click', this._chooseAttempt.bind(this));\n                            this._addPopoutButtons('[data-region=\"grade-panel\"] .gradeform');\n                            $(document).trigger('finish-loading-user');\n                            // Tell behat we are friends again.\n                            window.M.util.js_complete('mod-assign-loading-user');\n                        }.bind(this))\n                        .fail(notification.exception);\n                    }.bind(this)).fail(notification.exception);\n                    $('[data-region=\"review-panel\"]').show();\n                } else {\n                    this._region.hide();\n                    $('[data-region=\"review-panel\"]').hide();\n                    $(document).trigger('finish-loading-user');\n                    // Tell behat we are friends again.\n                    window.M.util.js_complete('mod-assign-loading-user');\n                }\n            }.bind(this));\n        }.bind(this)).fail(notification.exception);\n    };\n\n    /**\n     * Get next user data and store it in global variables\n     *\n     * @private\n     * @method _getNextUser\n     * @param {Event} event\n     * @param {Object} data Next user's data\n     */\n    GradingPanel.prototype._getNextUser = function(event, data) {\n        this.nextUserId = data.nextUserId;\n        this.nextUser = data.nextUser;\n    };\n\n    /**\n     * Handle the save-and-show-next event\n     *\n     * @private\n     * @method _handleSaveAndShowNext\n     */\n    GradingPanel.prototype._handleSaveAndShowNext = function() {\n        this._submitForm(null, this.nextUserId, this.nextUser);\n    };\n\n    /**\n     * Get the grade panel element.\n     *\n     * @method getPanelElement\n     * @return {jQuery}\n     */\n    GradingPanel.prototype.getPanelElement = function() {\n        return $('[data-region=\"grade-panel\"]');\n    };\n\n    /**\n     * Hide the grade panel.\n     *\n     * @method collapsePanel\n     */\n    GradingPanel.prototype.collapsePanel = function() {\n        this.getPanelElement().addClass('collapsed');\n    };\n\n    /**\n     * Show the grade panel.\n     *\n     * @method expandPanel\n     */\n    GradingPanel.prototype.expandPanel = function() {\n        this.getPanelElement().removeClass('collapsed');\n    };\n\n    /**\n     * Register event listeners for the grade panel.\n     *\n     * @method registerEventListeners\n     */\n    GradingPanel.prototype.registerEventListeners = function() {\n        var docElement = $(document);\n        var region = $(this._region);\n        // Add an event listener to prevent form submission when pressing enter key.\n        region.on('submit', 'form', function(e) {\n            e.preventDefault();\n        });\n\n        docElement.on('next-user', this._getNextUser.bind(this));\n        docElement.on('user-changed', this._refreshGradingPanel.bind(this));\n        docElement.on('save-changes', this._submitForm.bind(this));\n        docElement.on('save-and-show-next', this._handleSaveAndShowNext.bind(this));\n        docElement.on('reset', this._resetForm.bind(this));\n\n        docElement.on('save-form-state', this._saveFormState.bind(this));\n\n        docElement.on(GradingEvents.COLLAPSE_GRADE_PANEL, function() {\n            this.collapsePanel();\n        }.bind(this));\n\n        // We should expand if the review panel is collapsed.\n        docElement.on(GradingEvents.COLLAPSE_REVIEW_PANEL, function() {\n            this.expandPanel();\n        }.bind(this));\n\n        docElement.on(GradingEvents.EXPAND_GRADE_PANEL, function() {\n            this.expandPanel();\n        }.bind(this));\n    };\n\n    return GradingPanel;\n});\n"],"file":"grading_panel.min.js"}