function _typeof(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(a){return typeof a}}else{_typeof=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return _typeof(a)}define ("core_calendar/view_manager",["exports","jquery","core/templates","core/notification","core_calendar/repository","core_calendar/events","core_calendar/selectors","core/modal_factory","core/modal_events","core_calendar/summary_modal","core/custom_interaction_events","core/str","core/pending","core/prefetch"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.init=a.reloadCurrentUpcoming=a.updateUrl=a.changeDay=a.reloadCurrentDay=a.refreshDayContent=a.reloadCurrentMonth=a.changeMonth=a.refreshMonthContent=a.registerEventListenersForMonthDetailed=a.foldDayEvents=void 0;b=q(b);c=q(c);d=q(d);e=p(e);f=q(f);g=p(g);h=q(h);i=q(i);j=q(j);k=q(k);m=q(m);function o(){if("function"!=typeof WeakMap)return null;var a=new WeakMap;o=function(){return a};return a}function p(a){if(a&&a.__esModule){return a}if(null===a||"object"!==_typeof(a)&&"function"!=typeof a){return{default:a}}var b=o();if(b&&b.has(a)){return b.get(a)}var c={},d=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e in a){if(Object.prototype.hasOwnProperty.call(a,e)){var f=d?Object.getOwnPropertyDescriptor(a,e):null;if(f&&(f.get||f.set)){Object.defineProperty(c,e,f)}else{c[e]=a[e]}}}c.default=a;if(b){b.set(a,c)}return c}function q(a){return a&&a.__esModule?a:{default:a}}var r=function(){var a=(0,b.default)(g.elements.monthDetailed),c=a.find(g.day);if(0===c.length){return}c.each(function(){var a=(0,b.default)(this),c="".concat(g.elements.dateContent," ul li[data-event-eventtype]"),d="".concat(g.elements.dateContent," ul li[data-event-filtered=\"true\"]"),e="".concat(g.elements.dateContent," [data-action=\"view-more-events\"]"),f=a.find(c);if(0===f.length){return}var h=a.find(d),i=h.length,j=f.length-i,k=1;f.each(function(){var a=(0,b.default)(this),c="true"!==a.attr("data-event-filtered"),d=j===5?0:1;if(c){if(k>5-d){a.attr("data-event-folded","true");a.hide()}else{a.attr("data-event-folded","false");a.show();k++}}else{a.attr("data-event-folded","false")}});var m=a.find(e);if(j>5){m.show();(0,l.get_string)("moreevents","calendar",j-5+1).then(function(a){var b=m.find("strong a");m.attr("data-event-folded","false");b.text(a);return a}).fail()}else{m.hide()}})};a.foldDayEvents=r;var s=function(a){var c="".concat(f.default.viewUpdated);(0,b.default)("body").on(c,function(a){r(a)});r();(0,b.default)("body").on(f.default.filterChanged,function(c,d){var e=(0,b.default)(g.elements.monthDetailed),f=new m.default(a),h=e.find(g.eventType[d.type]),i=b.default.Deferred();if(d.hidden){i.then(function(){h.attr("data-event-filtered","true");return h.hide().promise()}).fail()}else{i.then(function(){h.attr("data-event-filtered","false");return h.show().promise()}).fail()}i.then(function(){r()}).always(f.resolve).fail();i.resolve()})};a.registerEventListenersForMonthDetailed=s;var t=function(a){a=(0,b.default)(a);a.on("click",g.links.eventLink,function(a){var b=a.target,c=null,d=null,e=new m.default("core_calendar/view_manager:eventLink:click");if(b.matches(g.actions.viewEvent)){c=b}else{c=b.closest(g.actions.viewEvent)}if(c){d=c.dataset.eventId}else{d=b.querySelector(g.actions.viewEvent).dataset.eventId}if(d){a.preventDefault();a.stopPropagation();F(d).then(e.resolve).catch()}else{e.resolve()}});a.on("click",g.links.navLink,function(b){var c=a.find(g.wrapper),d=c.data("view"),e=c.data("courseid"),f=c.data("categoryid"),h=b.currentTarget;if("month"===d||"monthblock"===d){v(a,h.href,h.dataset.year,h.dataset.month,e,f,h.dataset.day);b.preventDefault()}else if("day"===d){z(a,h.href,h.dataset.year,h.dataset.month,h.dataset.day,e,f);b.preventDefault()}});var c=a.find(g.viewSelector);k.default.define(c,[k.default.events.activate]);c.on(k.default.events.activate,function(b){b.preventDefault();var c=b.target;if(c.classList.contains("active")){return}var e=c.dataset.view,f=c.dataset.year,g=c.dataset.month,h=c.dataset.day,i=c.dataset.courseid,j=c.dataset.categoryid;if("month"==e){u(a,f,g,i,j,a,"core_calendar/calendar_month",h).then(function(){A("?view=month")}).fail(d.default.exception)}else if("day"==e){x(a,f,g,h,i,j,a,"core_calendar/calendar_day").then(function(){A("?view=day")}).fail(d.default.exception)}else if("upcoming"==e){D(a,i,j,a,"core_calendar/calendar_upcoming").then(function(){A("?view=upcoming")}).fail(d.default.exception)}})},u=function(a,b,h,i,j){var k=5<arguments.length&&arguments[5]!==void 0?arguments[5]:null,l=6<arguments.length&&arguments[6]!==void 0?arguments[6]:"",m=7<arguments.length&&arguments[7]!==void 0?arguments[7]:1;B(a);k=k||a.find(g.wrapper);l=l||a.attr("data-template");M.util.js_pending([a.get("id"),b,h,i].join("-"));var n=a.data("includenavigation"),o=a.data("mini"),p=k.data("view");return e.getCalendarMonthData(b,h,i,j,n,o,m,p).then(function(a){return c.default.render(l,a)}).then(function(a,b){return c.default.replaceNode(k,a,b)}).then(function(){document.querySelector("body").dispatchEvent(new CustomEvent(f.default.viewUpdated))}).always(function(){M.util.js_complete([a.get("id"),b,h,i].join("-"));return C(a)}).fail(d.default.exception)};a.refreshMonthContent=u;var v=function(a,c,d,e,g,h){var i=6<arguments.length&&arguments[6]!==void 0?arguments[6]:1;return u(a,d,e,g,h,null,"",i).then(function(){if(c.length&&"#"!==c){A(c)}for(var a=arguments.length,b=Array(a),d=0;d<a;d++){b[d]=arguments[d]}return b}).then(function(){(0,b.default)("body").trigger(f.default.monthChanged,[d,e,g,h]);for(var a=arguments.length,c=Array(a),i=0;i<a;i++){c[i]=arguments[i]}return c})};a.changeMonth=v;var w=function(a){var c=1<arguments.length&&arguments[1]!==void 0?arguments[1]:0,d=2<arguments.length&&arguments[2]!==void 0?arguments[2]:0,e=a.find(g.wrapper).data("year"),h=a.find(g.wrapper).data("month"),i=a.find(g.wrapper).data("day");c=c||a.find(g.wrapper).data("courseid");d=d||a.find(g.wrapper).data("categoryid");return u(a,e,h,c,d,null,"",i).then(function(){(0,b.default)("body").trigger(f.default.courseChanged,[e,h,c,d]);for(var a=arguments.length,g=Array(a),i=0;i<a;i++){g[i]=arguments[i]}return g})};a.reloadCurrentMonth=w;var x=function(a,b,h,i,j,k){var l=6<arguments.length&&arguments[6]!==void 0?arguments[6]:null,m=7<arguments.length&&arguments[7]!==void 0?arguments[7]:"";B(a);if(!l||0==l.length){l=a.find(g.wrapper)}m=m||a.attr("data-template");M.util.js_pending([a.get("id"),b,h,i,j,k].join("-"));var n=a.data("includenavigation");return e.getCalendarDayData(b,h,i,j,k,n).then(function(a){a.viewingday=!0;a.showviewselector=!0;return c.default.render(m,a)}).then(function(a,b){return c.default.replaceNode(l,a,b)}).then(function(){document.querySelector("body").dispatchEvent(new CustomEvent(f.default.viewUpdated))}).always(function(){M.util.js_complete([a.get("id"),b,h,i,j,k].join("-"));return C(a)}).fail(d.default.exception)};a.refreshDayContent=x;var y=function(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:0,c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:0,d=a.find(g.wrapper),e=d.data("year"),f=d.data("month"),h=d.data("day");b=b||a.find(g.wrapper).data("courseid");c=c||a.find(g.wrapper).data("categoryid");return x(a,e,f,h,b,c)};a.reloadCurrentDay=y;var z=function(a,c,d,e,g,h,i){return x(a,d,e,g,h,i).then(function(){if(c.length&&"#"!==c){A(c)}for(var a=arguments.length,b=Array(a),d=0;d<a;d++){b[d]=arguments[d]}return b}).then(function(){(0,b.default)("body").trigger(f.default.dayChanged,[d,e,h,i]);for(var a=arguments.length,c=Array(a),g=0;g<a;g++){c[g]=arguments[g]}return c})};a.changeDay=z;var A=function(a){var b=document.getElementById(g.fullCalendarView);if(b){window.history.pushState({},"",a)}};a.updateUrl=A;var B=function(a){var b=a.find(g.containers.loadingIcon);b.removeClass("hidden")},C=function(a){var b=a.find(g.containers.loadingIcon);b.addClass("hidden")},D=function(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:0,h=2<arguments.length&&arguments[2]!==void 0?arguments[2]:0,i=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null,j=4<arguments.length&&arguments[4]!==void 0?arguments[4]:"";B(a);i=i||a.find(g.wrapper);j=j||a.attr("data-template");b=b||a.find(g.wrapper).data("courseid");h=h||a.find(g.wrapper).data("categoryid");return e.getCalendarUpcomingData(b,h).then(function(a){a.viewingupcoming=!0;a.showviewselector=!0;return c.default.render(j,a)}).then(function(a,b){return c.default.replaceNode(i,a,b)}).then(function(){document.querySelector("body").dispatchEvent(new CustomEvent(f.default.viewUpdated))}).always(function(){return C(a)}).fail(d.default.exception)};a.reloadCurrentUpcoming=D;var E=function(a){return"calendar_event_"+a},F=function(a){var b=new m.default("core_calendar/view_manager:renderEventSummaryModal");return e.getEventById(a).then(function(b){if(!b.event){throw new Error("Error encountered while trying to fetch calendar event with ID: "+a)}return b.event}).then(function(a){var b={title:a.name,type:j.default.TYPE,body:c.default.render("core_calendar/event_summary_body",a),templateContext:{canedit:a.canedit,candelete:a.candelete,headerclasses:E(a.normalisedeventtype),isactionevent:a.isactionevent,url:a.url,action:a.action}};return h.default.create(b)}).then(function(a){a.getRoot().on(i.default.hidden,function(){a.destroy()});a.show();return a}).then(function(a){b.resolve();return a}).catch(d.default.exception)},G=function(a,b){(0,n.prefetchStrings)("calendar",["moreevents"]);r();t(a,b);var c=a.find(g.elements.monthDetailed);if(c.length){var d="month-detailed-".concat(c.id,"-filterChanged");s(c,d)}};a.init=G});
//# sourceMappingURL=view_manager.min.js.map
