{"version":3,"sources":["../src/manage_subscriptions.js"],"names":["getSubscriptionId","element","parseInt","closest","dataset","subid","getSubscriptionName","subname","getSubscriptionRow","subscriptionId","document","querySelector","createModal","messageCode","subscriptionName","Modal","create","type","types","SAVE_CANCEL","title","body","buttons","save","then","modal","getRoot","on","ModalEvents","hidden","focus","show","responseHandlerForDelete","data","status","warnings","message","registerEventListeners","addEventListener","e","deleteAction","target","CalendarSelectors","actions","deleteSubscription","preventDefault","modalPromise","CalendarRepository","response","subscriptionRow","remove","catch","displayException","eventTypes","elementUpdated","inplaceEditable","getAttribute","init","Prefetch","prefetchStrings"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A module to handle Delete/Update operations of the manage subscription page.\n *\n * @module core_calendar/manage_subscriptions\n * @copyright 2021 Huong Nguyen <huongnv13@gmail.com>\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since 4.0\n */\n\nimport * as CalendarSelectors from 'core_calendar/selectors';\nimport * as CalendarRepository from 'core_calendar/repository';\nimport * as Modal from 'core/modal_factory';\nimport * as ModalEvents from 'core/modal_events';\nimport {displayException, addNotification, fetchNotifications} from 'core/notification';\nimport Prefetch from 'core/prefetch';\nimport {get_string as getString} from 'core/str';\nimport {eventTypes} from 'core/local/inplace_editable/events';\n\n/**\n * Get subscription id for given element.\n *\n * @param {HTMLElement} element update/delete link\n * @return {Number}\n */\nconst getSubscriptionId = element => {\n    return parseInt(element.closest('tr').dataset.subid);\n};\n\n/**\n * Get subscription name for given element.\n *\n * @param {HTMLElement} element update/delete link\n * @return {String}\n */\nconst getSubscriptionName = element => {\n    return element.closest('tr').dataset.subname;\n};\n\n/**\n * Get subscription table row for subscription id.\n *\n * @param {string} subscriptionId Subscription id\n * @return {Element}\n */\nconst getSubscriptionRow = subscriptionId => {\n    return document.querySelector(`tr[data-subid=\"${subscriptionId}\"]`);\n};\n\n/**\n * Create modal.\n *\n * @param {HTMLElement} element\n * @param {string} messageCode Message code.\n * @return {promise} Promise for modal\n */\nconst createModal = (element, messageCode) => {\n    const subscriptionName = getSubscriptionName(element);\n    return Modal.create({\n        type: Modal.types.SAVE_CANCEL,\n        title: getString('confirmation', 'admin'),\n        body: getString(messageCode, 'calendar', subscriptionName),\n        buttons: {\n            save: getString('yes')\n        },\n    }).then(modal => {\n        modal.getRoot().on(ModalEvents.hidden, () => {\n            element.focus();\n        });\n        modal.show();\n        return modal;\n    });\n};\n\n/**\n * Response handler for delete action.\n *\n * @param {HTMLElement} element\n * @param {Object} data\n * @return {Promise}\n */\nconst responseHandlerForDelete = async(element, data) => {\n    const subscriptionName = getSubscriptionName(element);\n    const message = data.status ? await getString('subscriptionremoved', 'calendar', subscriptionName) : data.warnings[0].message;\n    const type = data.status ? 'info' : 'error';\n    return addNotification({message, type});\n};\n\n/**\n * Register events for update/delete links.\n */\nconst registerEventListeners = () => {\n    document.addEventListener('click', e => {\n        const deleteAction = e.target.closest(CalendarSelectors.actions.deleteSubscription);\n        if (deleteAction) {\n            e.preventDefault();\n            const modalPromise = createModal(deleteAction, 'confirmsubscriptiondelete');\n            modalPromise.then(modal => {\n                modal.getRoot().on(ModalEvents.save, () => {\n                    const subscriptionId = getSubscriptionId(deleteAction);\n                    CalendarRepository.deleteSubscription(subscriptionId).then(data => {\n                        const response = responseHandlerForDelete(deleteAction, data);\n                        return response.then(() => {\n                            const subscriptionRow = getSubscriptionRow(subscriptionId);\n                            return subscriptionRow.remove();\n                        });\n                    }).catch(displayException);\n                });\n\n                return modal;\n            }).catch(displayException);\n        }\n    });\n\n    document.addEventListener(eventTypes.elementUpdated, e => {\n        const inplaceEditable = e.target;\n        if (inplaceEditable.getAttribute('data-component') == 'core_calendar') {\n            fetchNotifications();\n        }\n    });\n};\n\n/**\n * Initialises.\n */\nexport const init = () => {\n    Prefetch.prefetchStrings('moodle', ['yes']);\n    Prefetch.prefetchStrings('core_admin', ['confirmation']);\n    Prefetch.prefetchStrings('core_calendar', ['confirmsubscriptiondelete', 'subscriptionremoved']);\n    registerEventListeners();\n};\n"],"file":"manage_subscriptions.min.js"}